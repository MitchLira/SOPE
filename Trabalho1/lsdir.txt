#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <dirent.h>
#include <sys/stat.h>
#include <errno.h>
#include <unistd.h>

#define BUFFER_LEN        256

int main(int argc, char *argv[]){
	DIR *dirp;
	struct dirent *direntp;
	struct stat stat_buf;
	pid_t pid;
	char nome_diretorio[BUFFER_LEN];
	
	if(argc != 2){
		fprintf(stderr, "Usage: %s dir_name\n", argv[0]);
		exit(1);
	}
	
	if((dirp = opendir(argv[1])) == NULL){
		perror(argv[1]);
		exit(2);
	}
	
	while ((direntp = readdir( dirp)) != NULL){
		sprintf(nome_diretorio, "%s/%s", argv[1], direntp->d_name);
		
		if (lstat(nome_diretorio, &stat_buf) < 0) 
        {
            perror(direntp->d_name);
            closedir(dirp);
            exit(3);
        }
				
		if (S_ISDIR(stat_buf.st_mode) && strcmp(direntp->d_name,"..") && strcmp(direntp->d_name,".")) {
			pid = fork();
			

			if (pid == 0) {
				execl("lsdir", "lsdir", (nome_diretorio), NULL);
			}
		}
		
		printf("%s\n", direntp->d_name);
	}
	
	closedir(dirp);
	exit(0);
}
